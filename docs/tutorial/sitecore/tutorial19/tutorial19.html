---
layout: DocsLayout
title: Tutorial 19 - Custom Data Handlers
---

{% include pageheader.html %}

<p>
    Glass.Mapper allows you to create you own data handlers to extend those supplied out of the box,
    this allows you to enhance Glass.Mapper to suit your solutions requirements.
</p>
<p>
    In this tutorial we will create a custom data handler that maps a field in Sitecore to a set of Twitter
    tweets. Lets start by looking at the field in Sitecore:
</p>
<img src="Tutorial19.field.PNG"/>
<p>
    This is just a simple Single Line Text field that allows the content editor to enter the Twitter username of 
    the person they want tweets for.
</p>
<p>
    The model we will use looks like this:
</p>
<pre class="cs">
    public class TwitterPage
    {
        public virtual Twitter Twitter { get; set; }
    }
</pre>
<p>
    You can see that the Twitter property is of type Twitter. This Twitter type is what our data handler
    will create and looks like this:
</p>
<pre class="cs">
    public class Twitter
    {
        public Twitter(string username, IEnumerable&lt;TweetSharp.TwitterStatus&gt; tweets)
        {
            Username = username;
            Tweets = tweets;
        }

        public  string Username { get; set; }
        public IEnumerable&lt;TweetSharp.TwitterStatus&gt; Tweets { get; private set; }
    }
</pre>
    
<p>
    Quite a simple class, notice that the Tweets are of type TwitterStatus  from the <a href="https://github.com/danielcrenna/tweetsharp">TweetSharp</a>
    project, I will be using the TweetSharp project to communicate with Twitter.
</p>
<p>
    Below shows all the code needed for the data handler:
</p>
<pre class="cs">
    public class TweetsDataHandler : Glass.Mapper.Sc.DataMappers.AbstractSitecoreFieldMapper
    {
        private const string ConsumerKey = "";
        private const string ConsumerSecret = "";
        private const string AccessToken = "";
        private const string AccessSecret = "";
        
        private const string CachePrefix = "95C2D29E-540E-43B6-B937-D29382039182";

        public TweetsDataHandler()
            : base(typeof (Twitter))
        {

        }

        public override string SetFieldValue(object value, SitecoreFieldConfiguration config, SitecoreDataMappingContext context)
        {
            var twitter = value as Twitter;
            return twitter == null ? string.Empty : twitter.Username;
        }

        public override object GetFieldValue(string fieldValue, SitecoreFieldConfiguration config, SitecoreDataMappingContext context)
        {
            if (string.IsNullOrWhiteSpace(fieldValue))
                return null;


            try
            {
                var cache = HttpContext.Current.Cache;
                var cacheKey = CachePrefix + fieldValue;

                Twitter twitter = null;
                if (cache != null && cache[cacheKey] != null)
                {
                    twitter = cache[cacheKey] as Twitter;
                }
                else
                {
                    var service = new TweetSharp.TwitterService(ConsumerKey, ConsumerSecret);
                    service.AuthenticateWith(AccessToken, AccessSecret);

                    var options = new TweetSharp.ListTweetsOnUserTimelineOptions();
                    options.ScreenName = fieldValue;
                    options.Count = 5;

                    var result = service.ListTweetsOnUserTimeline(options);

                    twitter = new Twitter(fieldValue, result);

                    if (cache != null)
                    {
                        cache.Add(cacheKey, twitter, null, DateTime.Now.AddMinutes(10), Cache.NoSlidingExpiration,
                                  CacheItemPriority.Low, null);
                    }

                }
                return twitter;
            }
            catch (Exception ex)
            {
                Sitecore.Diagnostics.Log.Error("Failed to get tweets", ex);
                return null;
            }
        }
    }

</pre>
<p>
    Firstly the handler inherits from the AbstractSitecoreFieldMapper class, you should use this class if you are mapping
    to and from a Sitecore field, otherwise use the AbstractDataMapper class if you want to map other item
    data.
</p>
<pre class="cs">
    public class TweetsDataHandler : Glass.Mapper.Sc.DataMappers.AbstractSitecoreFieldMapper
</pre>
<p>
    The AbstractSitecoreFieldMapper class takes a list of types that the data handler will handle, this 
    is passed via the constructor:
</p>
<pre class="cs">
 public TweetsDataHandler()
            : base(typeof (Twitter))
</pre>
<p>
    The SetFieldValue method is used to convert an object to a value that can be stored by site. You can see
    in our example that we just return the Username value on the Twitter class.
</p>
<pre class="cs">
        public override string SetFieldValue(object value, SitecoreFieldConfiguration config, SitecoreDataMappingContext context)
        {
            var twitter = value as Twitter;
            return twitter == null ? string.Empty : twitter.Username;
        }
</pre>
<p>
    The bulk of the work is performed by the GetFieldValue method which converts a Sitecore field value to a specific type.
    This code is relatively simple and includes some caching so we don't have to keep querying Twitter. The important
    part is to use the passed in field value from the fieldValue parameter.
</p>
<p>
    You will notice two other parameters on the methods that we haven't need to use:
</p>
<pre class="cs">
    SitecoreFieldConfiguration config, SitecoreDataMappingContext context
</pre>
<p>
    The config parameter contains the configuration for the property being mapped. The configuration would be set either
    by using attribute configuration or fluent configuration.
</p>
<p>
    The context parameter contains the information about the currently running Glass.Mapper/Sitecore context, via this you 
    can access the Item being mapped, the ISitecoreService currently being used and the final object that will be returned.
</p>
<p>
    Finally we need to register the data handler with the Castle Windsor container. Open the App_Start/GlassMapperScCustom
    class, this class is created automatically when you install Glass.Mapper.Sc.Windsor and update the CastleConfig method:
</p>
<pre class="cs">
		public static void CastleConfig(IWindsorContainer container){
			var config = new Config();

            container.Register(
              Component.For &lt; AbstractDataMapper&gt;().ImplementedBy&lt;TweetsDataHandler&gt;().LifestyleCustom&lt;NoTrackLifestyleManager&gt;()
              );

			container.Install(new SitecoreInstaller(config));
		}
</pre>
<p>
    Finally we just need to test this:
</p>
<pre class="cs">
            var context = new SitecoreContext();
            var item = context.GetCurrentItem&lt;TwitterPage&gt;();

            if (item.Twitter != null)
            {
                foreach (var tweet in  item.Twitter.Tweets)
                {
                    //do some work
                }
            }
</pre>

<p>
    That concludes this tutorial in which we have seen how you can extend Glass.Mapper to support mapping of your own custom 
    data types.
</p>